rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is an admin
    function isAdmin() {
      return isAuthenticated() &&
             request.auth.token.email != null;
    }

    // Helper function to check if user is accessing their own student data
    function isOwnStudent(studentId) {
      return isAuthenticated() && request.auth.uid == studentId;
    }

    // Regulations collection rules
    match /regulations/{regulationId} {
      // Anyone authenticated can read regulations
      allow read: if isAuthenticated();

      // Only admins can create regulations
      allow create: if isAdmin() &&
                      request.resource.data.keys().hasAll([
                        'residenceId', 'version', 'fileName',
                        'fileUrl', 'filePath', 'fileSize',
                        'isActive', 'publishedAt', 'createdAt',
                        'createdBy', 'updatedAt'
                      ]) &&
                      request.resource.data.version is string &&
                      request.resource.data.version.size() > 0 &&
                      request.resource.data.fileSize > 0 &&
                      request.resource.data.fileSize <= 10485760;

      // Only admins can update regulations
      allow update: if isAdmin();

      // Only admins can delete regulations
      allow delete: if isAdmin();
    }

    // Regulation audit logs collection rules
    // Immutable audit trail - no updates or deletes allowed
    match /regulation_audit_logs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();

      // Only admins can create audit logs
      allow create: if isAdmin() &&
                      request.resource.data.keys().hasAll([
                        'regulationId', 'residenceId', 'action',
                        'performedBy', 'performedByEmail', 'timestamp'
                      ]) &&
                      request.resource.data.action in ['CREATED', 'ACTIVATED', 'DEACTIVATED', 'DELETED'];

      // Audit logs are immutable - no updates or deletes allowed
      allow update, delete: if false;
    }

    // Residences collection rules
    match /residences/{residenceId} {
      // Anyone can read residences
      allow read: if true;

      // Only admins can write
      allow write: if isAdmin();
    }

    // Room types collection rules
    match /roomTypes/{roomTypeId} {
      // Anyone can read room types
      allow read: if true;

      // Only admins can write
      allow write: if isAdmin();
    }

    // Bookings collection rules
    match /bookings/{bookingId} {
      // Users can read their own bookings, admins can read all
      allow read: if isAuthenticated();

      // Anyone can create a booking (for public booking form)
      allow create: if true;

      // Only admins can update/delete bookings
      allow update, delete: if isAdmin();
    }

    // Settings collection rules
    match /settings/{document} {
      // Anyone can read settings
      allow read: if true;

      // Only admins can update settings
      allow write: if isAdmin();
    }

    // Students collection rules
    match /students/{studentId} {
      // Students can read their own data, admins can read all
      allow read: if isOwnStudent(studentId) || isAdmin();

      // Authenticated users can create students (admin creating via secondary auth)
      allow create: if isAuthenticated() &&
                      request.resource.data.keys().hasAll([
                        'email', 'name', 'phone', 'residenceId',
                        'bookingId', 'createdAt', 'updatedAt'
                      ]);

      // Students can update their own profile data
      allow update: if isOwnStudent(studentId);

      // Only admins can delete students
      allow delete: if isAdmin();
    }

    // Regulation acceptances collection rules
    match /regulation_acceptances/{acceptanceId} {
      // Students can read their own acceptances, admins can read all
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.studentId || isAdmin());

      // Students can create their own acceptances
      allow create: if isAuthenticated() &&
                      request.auth.uid == request.resource.data.studentId &&
                      request.resource.data.keys().hasAll([
                        'studentId', 'regulationId', 'regulationVersion',
                        'residenceId', 'acceptedAt'
                      ]);

      // Acceptances are immutable - no updates or deletes allowed
      allow update, delete: if false;
    }

    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
